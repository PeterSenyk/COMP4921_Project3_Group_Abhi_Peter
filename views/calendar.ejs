<%- include('templates/header') %>

<link
  href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.19/index.global.min.css"
  rel="stylesheet"
/>

<style>
  .calendar-container {
    padding: 2rem;
    max-width: 1400px;
    margin: 0 auto;
    background: white;
    border-radius: 10px;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
    margin-top: 2rem;
    margin-bottom: 2rem;
  }

  #calendar {
    max-width: 100%;
    margin: 0 auto;
  }

  /* Custom FullCalendar styling */
  .fc-toolbar-title {
    font-size: 1.5rem;
    font-weight: 600;
  }

  .fc-button {
    background-color: #667eea;
    border-color: #667eea;
  }

  .fc-button:hover {
    background-color: #5a67d8;
    border-color: #5a67d8;
  }

  .fc-button-active {
    background-color: #5a67d8;
    border-color: #5a67d8;
  }

  .fc-day-today {
    background-color: #f0f4ff !important;
  }

  .fc-timeGridDay-view .fc-day-today,
  .fc-timeGridWeek-view .fc-day-today {
    background-color: #f0f4ff !important;
  }

  .fc-event {
    cursor: pointer;
  }

  .fc-event:hover {
    opacity: 0.8;
  }

  /* Event Modal Styles */
  .event-modal {
    display: none;
    position: fixed;
    z-index: 10000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    overflow: auto;
    background-color: rgba(0, 0, 0, 0.5);
    animation: fadeIn 0.3s;
  }

  .event-modal.show {
    display: flex;
    align-items: center;
    justify-content: center;
  }

  @keyframes fadeIn {
    from {
      opacity: 0;
    }
    to {
      opacity: 1;
    }
  }

  .event-modal-content {
    background-color: white;
    margin: auto;
    padding: 2rem;
    border-radius: 10px;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
    max-width: 500px;
    width: 90%;
    animation: slideDown 0.3s;
    position: relative;
  }

  @keyframes slideDown {
    from {
      transform: translateY(-50px);
      opacity: 0;
    }
    to {
      transform: translateY(0);
      opacity: 1;
    }
  }

  .event-modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1.5rem;
    padding-bottom: 1rem;
    border-bottom: 2px solid #e0e0e0;
  }

  .event-modal-title {
    font-size: 1.5rem;
    font-weight: 600;
    color: #333;
    margin: 0;
  }

  .event-modal-close {
    background: none;
    border: none;
    font-size: 1.5rem;
    color: #999;
    cursor: pointer;
    padding: 0;
    width: 30px;
    height: 30px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 50%;
    transition: all 0.3s;
  }

  .event-modal-close:hover {
    background-color: #f0f0f0;
    color: #333;
  }

  .event-modal-body {
    margin-bottom: 1.5rem;
  }

  .event-modal-field {
    margin-bottom: 1rem;
  }

  .event-modal-label {
    font-weight: 600;
    color: #666;
    font-size: 0.9rem;
    margin-bottom: 0.25rem;
    display: block;
  }

  .event-modal-value {
    color: #333;
    font-size: 1rem;
  }

  .event-modal-description {
    color: #666;
    font-style: italic;
    min-height: 1.5rem;
  }

  .event-modal-footer {
    display: flex;
    gap: 0.5rem;
    justify-content: flex-end;
    padding-top: 1rem;
    border-top: 1px solid #e0e0e0;
  }

  .event-modal-btn {
    padding: 0.5rem 1rem;
    border: none;
    border-radius: 5px;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.3s;
    font-size: 0.9rem;
  }

  .event-modal-btn-close {
    background-color: #6c757d;
    color: white;
  }

  .event-modal-btn-close:hover {
    background-color: #5a6268;
  }

  .event-modal-btn-edit {
    background-color: #667eea;
    color: white;
  }

  .event-modal-btn-edit:hover {
    background-color: #5a67d8;
  }

  .event-modal-btn-delete {
    background-color: #dc3545;
    color: white;
  }

  .event-modal-btn-delete:hover {
    background-color: #c82333;
  }

  /* Event Form Modal Styles */
  .event-form-modal {
    display: none;
    position: fixed;
    z-index: 10001;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    overflow: auto;
    background-color: rgba(0, 0, 0, 0.5);
    animation: fadeIn 0.3s;
  }

  .event-form-modal.show {
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .event-form-modal-content {
    background-color: white;
    margin: auto;
    padding: 2rem;
    border-radius: 10px;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
    max-width: 600px;
    width: 90%;
    max-height: 90vh;
    overflow-y: auto;
    animation: slideDown 0.3s;
    position: relative;
  }

  .event-form-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1.5rem;
    padding-bottom: 1rem;
    border-bottom: 2px solid #e0e0e0;
  }

  .event-form-title {
    font-size: 1.5rem;
    font-weight: 600;
    color: #333;
    margin: 0;
  }

  .event-form-close {
    background: none;
    border: none;
    font-size: 1.5rem;
    color: #999;
    cursor: pointer;
    padding: 0;
    width: 30px;
    height: 30px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 50%;
    transition: all 0.3s;
  }

  .event-form-close:hover {
    background-color: #f0f0f0;
    color: #333;
  }

  .event-form-body {
    margin-bottom: 1.5rem;
  }

  .event-form-group {
    margin-bottom: 1.5rem;
  }

  .event-form-label {
    display: block;
    font-weight: 600;
    color: #333;
    margin-bottom: 0.5rem;
    font-size: 0.95rem;
  }

  .event-form-label.required::after {
    content: " *";
    color: #dc3545;
  }

  .event-form-input,
  .event-form-textarea {
    width: 100%;
    padding: 0.75rem;
    border: 1px solid #ddd;
    border-radius: 5px;
    font-size: 1rem;
    font-family: inherit;
    transition: border-color 0.3s;
    box-sizing: border-box;
  }

  .event-form-input:focus,
  .event-form-textarea:focus {
    outline: none;
    border-color: #667eea;
    box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
  }

  .event-form-textarea {
    resize: vertical;
    min-height: 100px;
  }

  .event-form-row {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 1rem;
  }

  @media (max-width: 600px) {
    .event-form-row {
      grid-template-columns: 1fr;
    }
  }

  .event-form-checkbox-group {
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }

  .event-form-checkbox {
    width: 18px;
    height: 18px;
    cursor: pointer;
  }

  .event-form-footer {
    display: flex;
    gap: 0.5rem;
    justify-content: flex-end;
    padding-top: 1rem;
    border-top: 1px solid #e0e0e0;
  }

  .event-form-btn {
    padding: 0.75rem 1.5rem;
    border: none;
    border-radius: 5px;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.3s;
    font-size: 1rem;
  }

  .event-form-btn-cancel {
    background-color: #6c757d;
    color: white;
  }

  .event-form-btn-cancel:hover {
    background-color: #5a6268;
  }

  .event-form-btn-submit {
    background-color: #667eea;
    color: white;
  }

  .event-form-btn-submit:hover {
    background-color: #5a67d8;
  }

  .event-form-btn-submit:disabled {
    background-color: #ccc;
    cursor: not-allowed;
  }

  .event-form-error {
    color: #dc3545;
    font-size: 0.875rem;
    margin-top: 0.25rem;
    display: none;
  }

  .event-form-error.show {
    display: block;
  }

  .event-form-colour-picker {
    display: flex;
    align-items: center;
    gap: 1rem;
  }

  .event-form-colour-options {
    display: flex;
    gap: 0.5rem;
    flex-wrap: wrap;
  }

  .event-form-colour-option {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    border: 3px solid transparent;
    cursor: pointer;
    transition: all 0.3s;
    position: relative;
  }

  .event-form-colour-option:hover {
    transform: scale(1.1);
    border-color: #333;
  }

  .event-form-colour-option.selected {
    border-color: #333;
    box-shadow: 0 0 0 3px rgba(0, 0, 0, 0.2);
  }

  .event-form-colour-option input[type="radio"] {
    position: absolute;
    opacity: 0;
    width: 100%;
    height: 100%;
    margin: 0;
    cursor: pointer;
  }

  /* Friend event styling (applied via eventDidMount) */
  .fc-event.friend-event {
    opacity: 0.8 !important;
    border-left: 6px solid !important;
    border-left-color: inherit !important;
    box-shadow: -2px 0 4px rgba(0, 0, 0, 0.15) !important;
  }

  .fc-event.friend-event:hover {
    opacity: 0.9 !important;
    box-shadow: -3px 0 6px rgba(0, 0, 0, 0.2) !important;
  }

  /* Friends Legend Styles */

  /* Friends Sidebar Styles */
  .calendar-wrapper {
    display: flex;
    gap: 1.5rem;
    max-width: 1600px;
    margin: 0 auto;
    padding: 2rem;
  }

  .friends-sidebar {
    width: 280px;
    background: white;
    border-radius: 10px;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
    padding: 1.5rem;
    height: fit-content;
    position: sticky;
    top: 100px;
  }

  .friends-sidebar-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1rem;
    padding-bottom: 1rem;
    border-bottom: 2px solid #e0e0e0;
  }

  .friends-sidebar-title {
    font-size: 1.25rem;
    font-weight: 600;
    color: #333;
    margin: 0;
  }

  .friends-sidebar-toggle {
    background: none;
    border: none;
    font-size: 1.5rem;
    color: #667eea;
    cursor: pointer;
    padding: 0.25rem;
    display: none;
  }

  .friends-sidebar-controls {
    display: flex;
    gap: 0.5rem;
    margin-bottom: 1rem;
    flex-direction: column;
  }

  .friends-sidebar-btn {
    flex: 1;
    padding: 0.5rem;
    border: 1px solid #667eea;
    border-radius: 5px;
    background: white;
    color: #667eea;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s;
    font-size: 0.85rem;
  }

  .friends-sidebar-btn:hover {
    background-color: #f0f4ff;
  }

  .friends-sidebar-btn.active {
    background-color: #667eea;
    color: white;
  }

  .friends-filter-toggle {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.75rem;
    margin-bottom: 0.5rem;
    border-radius: 5px;
    background-color: #f8f9fa;
    cursor: pointer;
    transition: all 0.2s;
  }

  .friends-filter-toggle:hover {
    background-color: #e9ecef;
  }

  .friends-filter-toggle input[type="checkbox"] {
    width: 18px;
    height: 18px;
    cursor: pointer;
    accent-color: #667eea;
  }

  .friends-filter-toggle-label {
    flex: 1;
    font-size: 0.9rem;
    font-weight: 500;
    color: #333;
    cursor: pointer;
  }

  .friends-filter-section {
    margin-bottom: 1rem;
    padding-bottom: 1rem;
    border-bottom: 2px solid #e0e0e0;
  }

  .friends-sidebar-btn-primary {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border: none;
  }

  .friends-sidebar-btn-primary:hover {
    background: linear-gradient(135deg, #5641c8 0%, #4a3784 100%);
  }

  /* Availability Modal Styles */
  .availability-modal {
    display: none;
    position: fixed;
    z-index: 10002;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    overflow: auto;
    background-color: rgba(0, 0, 0, 0.5);
    animation: fadeIn 0.3s;
  }

  .availability-modal.show {
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .availability-modal-content {
    background-color: white;
    margin: auto;
    padding: 2rem;
    border-radius: 10px;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
    max-width: 900px;
    width: 90%;
    max-height: 90vh;
    overflow-y: auto;
    animation: slideDown 0.3s;
    position: relative;
  }

  .availability-modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1.5rem;
    padding-bottom: 1rem;
    border-bottom: 2px solid #e0e0e0;
  }

  .availability-modal-title {
    font-size: 1.5rem;
    font-weight: 600;
    color: #333;
    margin: 0;
  }

  .availability-modal-close {
    background: none;
    border: none;
    font-size: 1.5rem;
    color: #999;
    cursor: pointer;
    padding: 0;
    width: 30px;
    height: 30px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 50%;
    transition: all 0.3s;
  }

  .availability-modal-close:hover {
    background-color: #f0f0f0;
    color: #333;
  }

  .availability-modal-body {
    margin-bottom: 1.5rem;
  }

  .availability-date-range {
    display: flex;
    gap: 1rem;
    margin-bottom: 1.5rem;
    flex-wrap: wrap;
    align-items: flex-end;
  }

  .availability-date-input-group {
    flex: 1;
    min-width: 200px;
  }

  .availability-date-label {
    display: block;
    font-size: 0.9rem;
    font-weight: 500;
    color: #333;
    margin-bottom: 0.5rem;
  }

  .availability-date-input {
    width: 100%;
    padding: 0.75rem;
    border: 1px solid #ddd;
    border-radius: 5px;
    font-size: 1rem;
    font-family: inherit;
  }

  .availability-date-input:focus {
    outline: none;
    border-color: #667eea;
    box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
  }

  .availability-load-btn {
    padding: 0.75rem 1.5rem;
    background-color: #667eea;
    color: white;
    border: none;
    border-radius: 5px;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.3s;
    font-size: 1rem;
    white-space: nowrap;
  }

  .availability-load-btn:hover {
    background-color: #5a67d8;
  }

  .availability-load-btn:disabled {
    background-color: #ccc;
    cursor: not-allowed;
  }

  .availability-section {
    margin-bottom: 2rem;
  }

  .availability-section-title {
    font-size: 1.25rem;
    font-weight: 600;
    color: #333;
    margin-bottom: 1rem;
    padding-bottom: 0.5rem;
    border-bottom: 1px solid #e0e0e0;
  }

  .availability-time-list {
    list-style: none;
    padding: 0;
    margin: 0;
  }

  .availability-time-item {
    padding: 0.75rem;
    margin-bottom: 0.5rem;
    border-radius: 5px;
    border-left: 4px solid;
  }

  .availability-time-item.busy {
    background-color: #fff5f5;
    border-left-color: #dc3545;
  }

  .availability-time-item.free {
    background-color: #f0fff4;
    border-left-color: #28a745;
  }

  .availability-time-range {
    font-weight: 600;
    color: #333;
    margin-bottom: 0.25rem;
  }

  .availability-time-details {
    font-size: 0.9rem;
    color: #666;
  }

  .availability-time-friend {
    font-weight: 500;
    color: #667eea;
  }

  .availability-empty {
    text-align: center;
    padding: 2rem;
    color: #666;
    font-style: italic;
  }

  .availability-loading {
    text-align: center;
    padding: 2rem;
    color: #667eea;
  }

  .availability-error {
    text-align: center;
    padding: 1rem;
    color: #dc3545;
    background-color: #fff5f5;
    border-radius: 5px;
    margin-bottom: 1rem;
  }

  .friends-sidebar-btn:hover {
    background: #667eea;
    color: white;
  }

  .friends-list {
    max-height: 500px;
    overflow-y: auto;
  }

  .friends-list-item {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    padding: 0.75rem;
    border-radius: 5px;
    transition: background-color 0.2s;
    margin-bottom: 0.5rem;
  }

  .friends-list-item:hover {
    background-color: #f5f5f5;
  }

  .friends-list-item input[type="checkbox"] {
    width: 18px;
    height: 18px;
    cursor: pointer;
    accent-color: #667eea;
  }

  .friends-list-item-label {
    flex: 1;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }

  .friend-username {
    font-weight: 500;
    color: #333;
  }

  .no-friends-message {
    text-align: center;
    padding: 2rem;
    color: #666;
    font-style: italic;
  }

  .calendar-main {
    flex: 1;
    background: white;
    border-radius: 10px;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
    padding: 2rem;
  }

  @media (max-width: 1024px) {
    .calendar-wrapper {
      flex-direction: column;
    }

    .friends-sidebar {
      width: 100%;
      position: relative;
      top: 0;
    }

    .friends-sidebar-toggle {
      display: block;
    }

    .friends-sidebar.collapsed .friends-list,
    .friends-sidebar.collapsed .friends-sidebar-controls {
      display: none;
    }
  }
</style>

<div class="calendar-wrapper">
  <!-- Friends Sidebar -->
  <div class="friends-sidebar" id="friendsSidebar">
    <div class="friends-sidebar-header">
      <h2 class="friends-sidebar-title">Friends' Calendars</h2>
      <button
        class="friends-sidebar-toggle"
        id="sidebarToggle"
        onclick="toggleFriendsSidebar()"
      >
        â˜°
      </button>
    </div>
    <div class="friends-sidebar-controls">
      <button class="friends-sidebar-btn" onclick="selectAllFriends()">
        Select All
      </button>
      <button class="friends-sidebar-btn" onclick="deselectAllFriends()">
        Deselect All
      </button>
      <button
        class="friends-sidebar-btn friends-sidebar-btn-primary"
        onclick="showAvailabilityModal()"
      >
        View Availability
      </button>
    </div>
    <div class="friends-filter-section">
      <div class="friends-filter-toggle">
        <input
          type="checkbox"
          id="toggleMyEvents"
          checked
          onchange="toggleMyEvents(this.checked)"
        />
        <label for="toggleMyEvents" class="friends-filter-toggle-label">
          Show My Events
        </label>
      </div>
      <div class="friends-filter-toggle">
        <input
          type="checkbox"
          id="toggleFriendEvents"
          checked
          onchange="toggleFriendEvents(this.checked)"
        />
        <label for="toggleFriendEvents" class="friends-filter-toggle-label">
          Show Friend Events
        </label>
      </div>
    </div>
    <div class="friends-list" id="friendsList">
      <div class="no-friends-message">Loading friends...</div>
    </div>
    <div class="friends-legend" id="friendsLegend" style="display: none">
      <div class="friends-legend-title">Event Colors</div>
      <div id="friendsLegendContent">
        <div class="friends-legend-empty">
          Select friends to see color legend
        </div>
      </div>
    </div>
  </div>

  <!-- Calendar Main Content -->
  <div class="calendar-main">
    <div id="calendar"></div>
  </div>
</div>

<!-- Event Details Modal -->
<div id="eventModal" class="event-modal">
  <div class="event-modal-content">
    <div class="event-modal-header">
      <h2 class="event-modal-title" id="modalEventTitle">Event Details</h2>
      <button class="event-modal-close" onclick="closeEventModal()">
        &times;
      </button>
    </div>
    <div class="event-modal-body">
      <div class="event-modal-field">
        <span class="event-modal-label">Start Time:</span>
        <div class="event-modal-value" id="modalEventStart"></div>
      </div>
      <div class="event-modal-field">
        <span class="event-modal-label">End Time:</span>
        <div class="event-modal-value" id="modalEventEnd"></div>
      </div>
      <div class="event-modal-field">
        <span class="event-modal-label">Description:</span>
        <div
          class="event-modal-value event-modal-description"
          id="modalEventDescription"
        >
          No description provided
        </div>
      </div>
    </div>
    <div class="event-modal-footer">
      <button
        class="event-modal-btn event-modal-btn-close"
        onclick="closeEventModal()"
      >
        Close
      </button>
      <button
        class="event-modal-btn event-modal-btn-edit"
        id="modalEditBtn"
        onclick="editEventFromModal()"
      >
        Edit
      </button>
      <button
        class="event-modal-btn event-modal-btn-delete"
        id="modalDeleteBtn"
        onclick="deleteEventFromModal()"
      >
        Delete
      </button>
    </div>
  </div>
</div>

<!-- Event Form Modal (Create/Edit) -->
<div id="eventFormModal" class="event-form-modal">
  <div class="event-form-modal-content">
    <div class="event-form-header">
      <h2 class="event-form-title" id="formModalTitle">Create Event</h2>
      <button class="event-form-close" onclick="closeEventFormModal()">
        &times;
      </button>
    </div>
    <form id="eventForm" onsubmit="handleEventFormSubmit(event)">
      <div class="event-form-body">
        <div class="event-form-group">
          <label for="eventTitle" class="event-form-label required"
            >Title</label
          >
          <input
            type="text"
            id="eventTitle"
            name="title"
            class="event-form-input"
            required
            placeholder="Enter event title"
          />
          <div class="event-form-error" id="titleError"></div>
        </div>

        <div class="event-form-row">
          <div class="event-form-group">
            <label for="eventStart" class="event-form-label required"
              >Start Date & Time</label
            >
            <input
              type="datetime-local"
              id="eventStart"
              name="start"
              class="event-form-input"
              required
            />
            <div class="event-form-error" id="startError"></div>
          </div>

          <div class="event-form-group">
            <label for="eventEnd" class="event-form-label required"
              >End Date & Time</label
            >
            <input
              type="datetime-local"
              id="eventEnd"
              name="end"
              class="event-form-input"
              required
            />
            <div class="event-form-error" id="endError"></div>
          </div>
        </div>

        <div class="event-form-group">
          <label for="eventDescription" class="event-form-label"
            >Description</label
          >
          <textarea
            id="eventDescription"
            name="description"
            class="event-form-textarea"
            placeholder="Enter event description (optional)"
          ></textarea>
        </div>

        <div class="event-form-group">
          <div class="event-form-checkbox-group">
            <input
              type="checkbox"
              id="eventAllDay"
              name="allDay"
              class="event-form-checkbox"
            />
            <label for="eventAllDay" class="event-form-label" style="margin: 0">
              All Day Event
            </label>
          </div>
        </div>

        <!-- Recurrence Section -->
        <div class="event-form-group">
          <label class="event-form-label">Recurrence</label>
          <select
            id="recurrenceType"
            name="recurrenceType"
            class="event-form-input"
            onchange="handleRecurrenceTypeChange()"
          >
            <option value="none">No Recurrence</option>
            <option value="daily">Every Day</option>
            <option value="weekly">Same Day(s) Every Week</option>
            <option value="monthly">Same Day(s) Every Month</option>
          </select>

          <!-- Weekly Recurrence Options -->
          <div
            id="weeklyRecurrenceOptions"
            style="display: none; margin-top: 1rem"
          >
            <label
              class="event-form-label"
              style="font-size: 0.9rem; margin-bottom: 0.5rem"
            >
              Select Days of Week:
            </label>
            <div style="display: flex; flex-wrap: wrap; gap: 0.5rem">
              <label
                style="
                  display: flex;
                  align-items: center;
                  gap: 0.25rem;
                  cursor: pointer;
                "
              >
                <input
                  type="checkbox"
                  name="recurrenceWeekday"
                  value="MONDAY"
                  class="event-form-checkbox"
                />
                <span>Mon</span>
              </label>
              <label
                style="
                  display: flex;
                  align-items: center;
                  gap: 0.25rem;
                  cursor: pointer;
                "
              >
                <input
                  type="checkbox"
                  name="recurrenceWeekday"
                  value="TUESDAY"
                  class="event-form-checkbox"
                />
                <span>Tue</span>
              </label>
              <label
                style="
                  display: flex;
                  align-items: center;
                  gap: 0.25rem;
                  cursor: pointer;
                "
              >
                <input
                  type="checkbox"
                  name="recurrenceWeekday"
                  value="WEDNESDAY"
                  class="event-form-checkbox"
                />
                <span>Wed</span>
              </label>
              <label
                style="
                  display: flex;
                  align-items: center;
                  gap: 0.25rem;
                  cursor: pointer;
                "
              >
                <input
                  type="checkbox"
                  name="recurrenceWeekday"
                  value="THURSDAY"
                  class="event-form-checkbox"
                />
                <span>Thu</span>
              </label>
              <label
                style="
                  display: flex;
                  align-items: center;
                  gap: 0.25rem;
                  cursor: pointer;
                "
              >
                <input
                  type="checkbox"
                  name="recurrenceWeekday"
                  value="FRIDAY"
                  class="event-form-checkbox"
                />
                <span>Fri</span>
              </label>
              <label
                style="
                  display: flex;
                  align-items: center;
                  gap: 0.25rem;
                  cursor: pointer;
                "
              >
                <input
                  type="checkbox"
                  name="recurrenceWeekday"
                  value="SATURDAY"
                  class="event-form-checkbox"
                />
                <span>Sat</span>
              </label>
              <label
                style="
                  display: flex;
                  align-items: center;
                  gap: 0.25rem;
                  cursor: pointer;
                "
              >
                <input
                  type="checkbox"
                  name="recurrenceWeekday"
                  value="SUNDAY"
                  class="event-form-checkbox"
                />
                <span>Sun</span>
              </label>
            </div>
          </div>

          <!-- Monthly Recurrence Options -->
          <div
            id="monthlyRecurrenceOptions"
            style="display: none; margin-top: 1rem"
          >
            <label
              class="event-form-label"
              style="font-size: 0.9rem; margin-bottom: 0.5rem"
            >
              Select Days of Month (1-31):
            </label>
            <input
              type="text"
              id="recurrenceMonthDays"
              name="recurrenceMonthDays"
              class="event-form-input"
              placeholder="e.g., 1, 15 (comma-separated)"
              style="font-size: 0.9rem"
            />
            <div style="font-size: 0.8rem; color: #666; margin-top: 0.25rem">
              Enter day numbers separated by commas (e.g., 1, 15 for 1st and
              15th)
            </div>
          </div>

          <!-- Recurrence End Date (optional) -->
          <div
            id="recurrenceEndDateOptions"
            style="display: none; margin-top: 1rem"
          >
            <label
              for="recurrenceEndDate"
              class="event-form-label"
              style="font-size: 0.9rem; margin-bottom: 0.5rem"
            >
              End Date (Optional):
            </label>
            <input
              type="date"
              id="recurrenceEndDate"
              name="recurrenceEndDate"
              class="event-form-input"
              style="font-size: 0.9rem"
            />
            <div style="font-size: 0.8rem; color: #666; margin-top: 0.25rem">
              Leave empty for no end date
            </div>
          </div>
        </div>

        <div class="event-form-group">
          <label class="event-form-label">Colour</label>
          <div class="event-form-colour-picker">
            <div class="event-form-colour-options" id="colourOptions">
              <div
                class="event-form-colour-option"
                data-colour="#0000af"
                style="background-color: #0000af"
                title="Blue"
              >
                <input
                  type="radio"
                  name="colour"
                  value="#0000af"
                  id="colour-blue"
                />
              </div>
              <div
                class="event-form-colour-option"
                data-colour="#dc3545"
                style="background-color: #dc3545"
                title="Red"
              >
                <input
                  type="radio"
                  name="colour"
                  value="#dc3545"
                  id="colour-red"
                />
              </div>
              <div
                class="event-form-colour-option"
                data-colour="#28a745"
                style="background-color: #28a745"
                title="Green"
              >
                <input
                  type="radio"
                  name="colour"
                  value="#28a745"
                  id="colour-green"
                />
              </div>
              <div
                class="event-form-colour-option"
                data-colour="#ffc107"
                style="background-color: #ffc107"
                title="Yellow"
              >
                <input
                  type="radio"
                  name="colour"
                  value="#ffc107"
                  id="colour-yellow"
                />
              </div>
              <div
                class="event-form-colour-option"
                data-colour="#17a2b8"
                style="background-color: #17a2b8"
                title="Cyan"
              >
                <input
                  type="radio"
                  name="colour"
                  value="#17a2b8"
                  id="colour-cyan"
                />
              </div>
              <div
                class="event-form-colour-option"
                data-colour="#6f42c1"
                style="background-color: #6f42c1"
                title="Purple"
              >
                <input
                  type="radio"
                  name="colour"
                  value="#6f42c1"
                  id="colour-purple"
                />
              </div>
              <div
                class="event-form-colour-option"
                data-colour="#fd7e14"
                style="background-color: #fd7e14"
                title="Orange"
              >
                <input
                  type="radio"
                  name="colour"
                  value="#fd7e14"
                  id="colour-orange"
                />
              </div>
              <div
                class="event-form-colour-option"
                data-colour="#e83e8c"
                style="background-color: #e83e8c"
                title="Pink"
              >
                <input
                  type="radio"
                  name="colour"
                  value="#e83e8c"
                  id="colour-pink"
                />
              </div>
              <div
                class="event-form-colour-option"
                data-colour="#20c997"
                style="background-color: #20c997"
                title="Teal"
              >
                <input
                  type="radio"
                  name="colour"
                  value="#20c997"
                  id="colour-teal"
                />
              </div>
              <div
                class="event-form-colour-option"
                data-colour="#6c757d"
                style="background-color: #6c757d"
                title="Gray"
              >
                <input
                  type="radio"
                  name="colour"
                  value="#6c757d"
                  id="colour-gray"
                />
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="event-form-footer">
        <button
          type="button"
          class="event-form-btn event-form-btn-cancel"
          onclick="closeEventFormModal()"
        >
          Cancel
        </button>
        <button
          type="submit"
          class="event-form-btn event-form-btn-submit"
          id="formSubmitBtn"
        >
          Create Event
        </button>
      </div>
    </form>
  </div>
</div>

<!-- Availability Modal -->
<div id="availabilityModal" class="availability-modal">
  <div class="availability-modal-content">
    <div class="availability-modal-header">
      <h2 class="availability-modal-title">Friends' Availability</h2>
      <button
        class="availability-modal-close"
        onclick="closeAvailabilityModal()"
      >
        &times;
      </button>
    </div>
    <div class="availability-modal-body">
      <div class="availability-date-range">
        <div class="availability-date-input-group">
          <label for="availabilityStartDate" class="availability-date-label">
            Start Date
          </label>
          <input
            type="date"
            id="availabilityStartDate"
            class="availability-date-input"
            required
          />
        </div>
        <div class="availability-date-input-group">
          <label for="availabilityEndDate" class="availability-date-label">
            End Date
          </label>
          <input
            type="date"
            id="availabilityEndDate"
            class="availability-date-input"
            required
          />
        </div>
        <button
          class="availability-load-btn"
          onclick="loadAvailability()"
          id="loadAvailabilityBtn"
        >
          Load Availability
        </button>
      </div>
      <div
        id="availabilityError"
        class="availability-error"
        style="display: none"
      ></div>
      <div id="availabilityContent">
        <div class="availability-empty">
          Select a date range and click "Load Availability" to see when your
          friends are free or busy.
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Availability Modal -->
<div id="availabilityModal" class="availability-modal">
  <div class="availability-modal-content">
    <div class="availability-modal-header">
      <h2 class="availability-modal-title">Friends' Availability</h2>
      <button
        class="availability-modal-close"
        onclick="closeAvailabilityModal()"
      >
        &times;
      </button>
    </div>
    <div class="availability-modal-body">
      <div class="availability-date-range">
        <div class="availability-date-input-group">
          <label for="availabilityStartDate" class="availability-date-label">
            Start Date
          </label>
          <input
            type="date"
            id="availabilityStartDate"
            class="availability-date-input"
            required
          />
        </div>
        <div class="availability-date-input-group">
          <label for="availabilityEndDate" class="availability-date-label">
            End Date
          </label>
          <input
            type="date"
            id="availabilityEndDate"
            class="availability-date-input"
            required
          />
        </div>
        <button
          class="availability-load-btn"
          onclick="loadAvailability()"
          id="loadAvailabilityBtn"
        >
          Load Availability
        </button>
      </div>
      <div
        id="availabilityError"
        class="availability-error"
        style="display: none"
      ></div>
      <div id="availabilityContent">
        <div class="availability-empty">
          Select a date range and click "Load Availability" to see when your
          friends are free or busy.
        </div>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.19/index.global.min.js"></script>
<script>
  // Pass events data to the calendar utils script
  window.initialEventsData = <%- events %>;
</script>
<script src="/utils/calendar-utils.js"></script>

<script>
  // Friends Sidebar Functionality
  let friendsList = [];
  let selectedFriendIds = new Set();

  // Filter toggles
  let showMyEvents = true;
  let showFriendEvents = true;

  // Gray color palette for friend events
  const grayColours = [
    "#ced4da",
    "#adb5bd",
    "#6c757d",
    "#495057",
    "#343a40",
    "#212529",
  ];

  // Map friend IDs to their assigned gray color (for consistency)
  const friendColorMap = new Map();

  // Get a random gray color for a friend (consistent per friend)
  function getFriendGrayColor(friendId) {
    if (!friendColorMap.has(friendId)) {
      // Use friendId as seed for consistent color assignment
      const colorIndex = friendId % grayColours.length;
      friendColorMap.set(friendId, grayColours[colorIndex]);
    }
    return friendColorMap.get(friendId);
  }

  // Toggle my events visibility
  window.toggleMyEvents = function (show) {
    showMyEvents = show;
    if (!window.calendar) return;

    const userEventsSource = window.calendar.getEventSourceById("user-events");
    if (userEventsSource) {
      if (show) {
        // Source is already added, just refresh
        userEventsSource.refetch();
      } else {
        // Hide user events by removing the source
        userEventsSource.remove();
      }
    } else if (show) {
      // Re-add user events source if it was removed
      window.calendar.addEventSource({
        id: "user-events",
        events: function (fetchInfo, successCallback, failureCallback) {
          fetch(
            "/api/events?start=" +
              fetchInfo.startStr +
              "&end=" +
              fetchInfo.endStr
          )
            .then((response) => response.json())
            .then((data) => {
              successCallback(data);
            })
            .catch((error) => {
              console.error("Error fetching user events:", error);
              successCallback(window.initialEventsData || []);
              failureCallback(error);
            });
        },
        editable: true,
        color: "#0000af",
      });
    }
  };

  // Toggle friend events visibility
  window.toggleFriendEvents = function (show) {
    showFriendEvents = show;
    if (!show) {
      // Remove all friend event sources
      const allFriendIds = Array.from(selectedFriendIds);
      allFriendIds.forEach((friendId) => {
        const existingSource = window.calendar.getEventSourceById(
          `friend-${friendId}`
        );
        if (existingSource) {
          existingSource.remove();
        }
      });
      // Also remove old single source if it exists
      const oldSource = window.calendar.getEventSourceById("friend-events");
      if (oldSource) {
        oldSource.remove();
      }
    } else {
      // Reload friend events if friends are selected
      if (selectedFriendIds.size > 0) {
        loadFriendEvents();
      }
    }
  };

  // Fetch friends from API
  async function loadFriends() {
    try {
      const response = await fetch("/api/friends");
      if (!response.ok) {
        throw new Error("Failed to fetch friends");
      }
      friendsList = await response.json();
      renderFriendsList();
    } catch (error) {
      console.error("Error loading friends:", error);
      document.getElementById("friendsList").innerHTML =
        '<div class="no-friends-message">Failed to load friends</div>';
    }
  }

  // Render friends list with checkboxes
  function renderFriendsList() {
    const friendsListEl = document.getElementById("friendsList");

    if (friendsList.length === 0) {
      friendsListEl.innerHTML =
        '<div class="no-friends-message">No accepted friends found</div>';
      return;
    }

    // Filter to only show ACCEPTED friends
    const acceptedFriends = friendsList.filter((f) => f.status === "ACCEPTED");

    if (acceptedFriends.length === 0) {
      friendsListEl.innerHTML =
        '<div class="no-friends-message">No accepted friends found</div>';
      return;
    }

    friendsListEl.innerHTML = acceptedFriends
      .map(
        (friend) => `
      <div class="friends-list-item">
        <input
          type="checkbox"
          id="friend-${friend.user_id}"
          value="${friend.user_id}"
          onchange="handleFriendSelection(${friend.user_id}, this.checked)"
          ${selectedFriendIds.has(friend.user_id) ? "checked" : ""}
        />
        <label for="friend-${friend.user_id}" class="friends-list-item-label">
          <span class="friend-username">${friend.username}</span>
        </label>
      </div>
    `
      )
      .join("");
  }

  // Load friend events and add to calendar
  function loadFriendEvents() {
    // Wait for calendar to be initialized
    if (!window.calendar) {
      // Retry after a short delay if calendar isn't ready yet
      setTimeout(loadFriendEvents, 100);
      return;
    }

    // Get friend IDs array once
    const friendIdsArray = Array.from(selectedFriendIds);

    // Remove all existing friend event sources
    friendIdsArray.forEach((friendId) => {
      const existingSource = window.calendar.getEventSourceById(
        `friend-${friendId}`
      );
      if (existingSource) {
        existingSource.remove();
      }
    });

    // Also remove the old single source if it exists (for backward compatibility)
    const oldSource = window.calendar.getEventSourceById("friend-events");
    if (oldSource) {
      oldSource.remove();
    }

    // If no friends selected or friend events are hidden, don't add friend events source
    if (friendIdsArray.length === 0 || !showFriendEvents) {
      return;
    }

    // Create separate event source for each friend (for individual gray color coding)

    friendIdsArray.forEach((friendId) => {
      const friendGrayColor = getFriendGrayColor(friendId);
      const friend = friendsList.find((f) => f.user_id === friendId);
      const friendUsername = friend ? friend.username : `Friend ${friendId}`;

      const friendEventsSource = {
        id: `friend-${friendId}`,
        events: function (fetchInfo, successCallback, failureCallback) {
          // Make one API call for all friends, then filter client-side
          const friendIdsParam = friendIdsArray.join(",");
          fetch(
            `/api/friends/events?friendIds=${friendIdsParam}&start=${fetchInfo.startStr}&end=${fetchInfo.endStr}`
          )
            .then((response) => response.json())
            .then((data) => {
              // Filter events to only include this friend's events
              const friendEvents = data
                .filter(
                  (event) =>
                    event.extendedProps.friend_username === friendUsername
                )
                .map((event) => {
                  // Override event color with friend's assigned gray color
                  return {
                    ...event,
                    color: friendGrayColor,
                    backgroundColor: friendGrayColor,
                    borderColor: friendGrayColor,
                  };
                });
              successCallback(friendEvents);
            })
            .catch((error) => {
              console.error(
                `Error fetching events for friend ${friendId}:`,
                error
              );
              successCallback([]);
              failureCallback(error);
            });
        },
        editable: false, // Friend events cannot be edited
        color: friendGrayColor, // Random gray color per friend
        textColor: "#ffffff",
      };

      // Add friend events source to calendar
      window.calendar.addEventSource(friendEventsSource);
    });
  }

  // Handle individual friend selection
  window.handleFriendSelection = function (friendId, isSelected) {
    if (isSelected) {
      selectedFriendIds.add(friendId);
    } else {
      selectedFriendIds.delete(friendId);
    }
    // Load/unload friend events based on selection
    loadFriendEvents();
  };

  // Select all friends
  window.selectAllFriends = function () {
    const acceptedFriends = friendsList.filter((f) => f.status === "ACCEPTED");
    acceptedFriends.forEach((friend) => {
      selectedFriendIds.add(friend.user_id);
      const checkbox = document.getElementById(`friend-${friend.user_id}`);
      if (checkbox) checkbox.checked = true;
    });
    // Load friend events for all selected friends
    loadFriendEvents();
  };

  // Deselect all friends
  window.deselectAllFriends = function () {
    selectedFriendIds.clear();
    const checkboxes = document.querySelectorAll(
      '#friendsList input[type="checkbox"]'
    );
    checkboxes.forEach((checkbox) => {
      checkbox.checked = false;
    });
    // Remove friend events from calendar
    loadFriendEvents();
  };

  // Toggle sidebar (for mobile)
  window.toggleFriendsSidebar = function () {
    const sidebar = document.getElementById("friendsSidebar");
    sidebar.classList.toggle("collapsed");
  };

  // Load friends when page loads
  document.addEventListener("DOMContentLoaded", function () {
    loadFriends();
  });

  // Availability Modal Functions
  window.showAvailabilityModal = function () {
    const modal = document.getElementById("availabilityModal");
    if (modal) {
      modal.classList.add("show");
      // Set default date range (today to 7 days from now)
      const today = new Date();
      const nextWeek = new Date(today);
      nextWeek.setDate(nextWeek.getDate() + 7);

      document.getElementById("availabilityStartDate").value = today
        .toISOString()
        .split("T")[0];
      document.getElementById("availabilityEndDate").value = nextWeek
        .toISOString()
        .split("T")[0];
    }
  };

  window.closeAvailabilityModal = function () {
    const modal = document.getElementById("availabilityModal");
    if (modal) {
      modal.classList.remove("show");
    }
  };

  // Format date and time for display
  function formatDateTime(dateString) {
    const date = new Date(dateString);
    return date.toLocaleString("en-US", {
      weekday: "short",
      year: "numeric",
      month: "short",
      day: "numeric",
      hour: "numeric",
      minute: "2-digit",
      hour12: true,
    });
  }

  // Format time range for display
  function formatTimeRange(start, end) {
    const startDate = new Date(start);
    const endDate = new Date(end);
    const sameDay = startDate.toDateString() === endDate.toDateString();

    if (sameDay) {
      return `${formatDateTime(start)} - ${endDate.toLocaleTimeString("en-US", {
        hour: "numeric",
        minute: "2-digit",
        hour12: true,
      })}`;
    } else {
      return `${formatDateTime(start)} - ${formatDateTime(end)}`;
    }
  }

  // Load availability data
  window.loadAvailability = async function () {
    const startDateInput = document.getElementById("availabilityStartDate");
    const endDateInput = document.getElementById("availabilityEndDate");
    const errorDiv = document.getElementById("availabilityError");
    const contentDiv = document.getElementById("availabilityContent");
    const loadBtn = document.getElementById("loadAvailabilityBtn");

    // Validate inputs
    if (!startDateInput.value || !endDateInput.value) {
      errorDiv.textContent = "Please select both start and end dates";
      errorDiv.style.display = "block";
      return;
    }

    const startDate = new Date(startDateInput.value);
    const endDate = new Date(endDateInput.value);

    if (isNaN(startDate.getTime()) || isNaN(endDate.getTime())) {
      errorDiv.textContent = "Invalid date format";
      errorDiv.style.display = "block";
      return;
    }

    if (startDate >= endDate) {
      errorDiv.textContent = "Start date must be before end date";
      errorDiv.style.display = "block";
      return;
    }

    // Check if any friends are selected
    if (selectedFriendIds.size === 0) {
      errorDiv.textContent =
        "Please select at least one friend to view availability";
      errorDiv.style.display = "block";
      return;
    }

    // Hide error, show loading
    errorDiv.style.display = "none";
    loadBtn.disabled = true;
    loadBtn.textContent = "Loading...";
    contentDiv.innerHTML =
      '<div class="availability-loading">Loading availability...</div>';

    try {
      const friendIdsArray = Array.from(selectedFriendIds);
      const friendIdsParam = friendIdsArray.join(",");
      const startParam = startDate.toISOString();
      const endParam = endDate.toISOString();

      const response = await fetch(
        `/api/friends/availability?friendIds=${friendIdsParam}&start=${startParam}&end=${endParam}`
      );

      if (!response.ok) {
        const errorData = await response.json();
        throw new Error(errorData.error || "Failed to fetch availability");
      }

      const availability = await response.json();

      // Display availability data
      let html = "";

      // Busy Times Section
      if (availability.busyTimes && availability.busyTimes.length > 0) {
        html += '<div class="availability-section">';
        html += '<h3 class="availability-section-title">Busy Times</h3>';
        html += '<ul class="availability-time-list">';

        availability.busyTimes.forEach((busyTime) => {
          html += '<li class="availability-time-item busy">';
          html += `<div class="availability-time-range">${formatTimeRange(
            busyTime.start,
            busyTime.end
          )}</div>`;
          html += `<div class="availability-time-details">`;
          html += `<span class="availability-time-friend">${
            busyTime.friendName || "Unknown"
          }</span>`;
          if (busyTime.eventTitle) {
            html += ` - ${busyTime.eventTitle}`;
          }
          html += `</div>`;
          html += `</li>`;
        });

        html += "</ul>";
        html += "</div>";
      } else {
        html += '<div class="availability-section">';
        html += '<h3 class="availability-section-title">Busy Times</h3>';
        html +=
          '<div class="availability-empty">No busy times found in this date range</div>';
        html += "</div>";
      }

      // Free Times Section
      if (availability.freeTimes && availability.freeTimes.length > 0) {
        html += '<div class="availability-section">';
        html += '<h3 class="availability-section-title">Free Times</h3>';
        html += '<ul class="availability-time-list">';

        availability.freeTimes.forEach((freeTime) => {
          html += '<li class="availability-time-item free">';
          html += `<div class="availability-time-range">${formatTimeRange(
            freeTime.start,
            freeTime.end
          )}</div>`;
          html += `<div class="availability-time-details">All selected friends are available</div>`;
          html += `</li>`;
        });

        html += "</ul>";
        html += "</div>";
      } else {
        html += '<div class="availability-section">';
        html += '<h3 class="availability-section-title">Free Times</h3>';
        html +=
          '<div class="availability-empty">No free times found in this date range</div>';
        html += "</div>";
      }

      contentDiv.innerHTML = html;
    } catch (error) {
      console.error("Error loading availability:", error);
      errorDiv.textContent =
        error.message || "Failed to load availability. Please try again.";
      errorDiv.style.display = "block";
      contentDiv.innerHTML =
        '<div class="availability-empty">Error loading availability</div>';
    } finally {
      loadBtn.disabled = false;
      loadBtn.textContent = "Load Availability";
    }
  };

  // Close modal when clicking outside
  document.addEventListener("click", function (event) {
    const modal = document.getElementById("availabilityModal");
    if (event.target === modal) {
      closeAvailabilityModal();
    }
  });
</script>

<%- include('templates/footer') %>

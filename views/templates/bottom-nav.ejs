<!-- Bottom Navigation Module -->
<div class="bottom-nav">
    <button class="camera-btn photo-btn" onclick="openPhotoCapture()">
        <i>ðŸ“·</i>
        <span>Take Photo</span>
    </button>
    <button class="camera-btn video-btn" onclick="openVideoCapture()">
        <i>ðŸŽ¥</i>
        <span>Take Video</span>
    </button>
</div>

<!-- Video Capture Modal -->
<div id="videoModal" class="modal" style="display: none;">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Record Video (30s max)</h3>
            <button class="close-btn" onclick="closeVideoModal()">&times;</button>
        </div>
        <div class="modal-body">
            <video id="videoPreview" autoplay muted style="width: 100%; max-height: 300px; background: #000;"></video>
            <div class="video-controls">
                <button id="startRecording" class="record-btn" onclick="startVideoRecording()">Start Recording</button>
                <button id="stopRecording" class="record-btn stop-btn" onclick="stopVideoRecording()" style="display: none;">Stop Recording</button>
                <div id="timer" class="timer" style="display: none;">00:00</div>
            </div>
            <div id="recordingStatus" class="recording-status"></div>
        </div>
    </div>
</div>

<!-- Photo Capture Modal -->
<div id="photoModal" class="modal" style="display: none;">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Take Photo</h3>
            <button class="close-btn" onclick="closePhotoModal()">&times;</button>
        </div>
        <div class="modal-body">
            <video id="photoPreview" autoplay muted style="width: 100%; max-height: 300px; background: #000;"></video>
            <div class="photo-controls">
                <button id="capturePhoto" class="capture-btn" onclick="capturePhoto()">Capture Photo</button>
            </div>
        </div>
    </div>
</div>

<script>
    let mediaRecorder;
    let recordedChunks = [];
    let recordingTimer;
    let recordingStartTime;
    
    // Video Capture Functions
    function openVideoCapture() {
        document.getElementById('videoModal').style.display = 'block';
        startVideoStream();
    }
    
    function closeVideoModal() {
        document.getElementById('videoModal').style.display = 'none';
        stopVideoStream();
    }
    
    function startVideoStream() {
        navigator.mediaDevices.getUserMedia({ video: true, audio: true })
            .then(stream => {
                const videoPreview = document.getElementById('videoPreview');
                videoPreview.srcObject = stream;
                window.videoStream = stream;
            })
            .catch(err => {
                console.error('Error accessing camera:', err);
                alert('Unable to access camera. Please check permissions.');
            });
    }
    
    function stopVideoStream() {
        if (window.videoStream) {
            window.videoStream.getTracks().forEach(track => track.stop());
            window.videoStream = null;
        }
    }
    
    function startVideoRecording() {
        if (!window.videoStream) {
            alert('Camera not available');
            return;
        }
        
        recordedChunks = [];
        mediaRecorder = new MediaRecorder(window.videoStream);
        
        mediaRecorder.ondataavailable = event => {
            if (event.data.size > 0) {
                recordedChunks.push(event.data);
            }
        };
        
        mediaRecorder.onstop = () => {
            const blob = new Blob(recordedChunks, { type: 'video/webm' });
            uploadVideo(blob);
        };
        
        mediaRecorder.start();
        recordingStartTime = Date.now();
        
        // Update UI
        document.getElementById('startRecording').style.display = 'none';
        document.getElementById('stopRecording').style.display = 'inline-block';
        document.getElementById('timer').style.display = 'block';
        document.getElementById('recordingStatus').textContent = 'Recording...';
        document.getElementById('recordingStatus').style.color = '#dc3545';
        
        // Start timer
        recordingTimer = setInterval(updateTimer, 100);
        
        // Auto-stop at 30 seconds
        setTimeout(() => {
            if (mediaRecorder && mediaRecorder.state === 'recording') {
                stopVideoRecording();
            }
        }, 30000);
    }
    
    function stopVideoRecording() {
        if (mediaRecorder && mediaRecorder.state === 'recording') {
            mediaRecorder.stop();
        }
        
        clearInterval(recordingTimer);
        
        // Update UI
        document.getElementById('startRecording').style.display = 'inline-block';
        document.getElementById('stopRecording').style.display = 'none';
        document.getElementById('timer').style.display = 'none';
        document.getElementById('recordingStatus').textContent = 'Processing video...';
        document.getElementById('recordingStatus').style.color = '#28a745';
    }
    
    function updateTimer() {
        const elapsed = Date.now() - recordingStartTime;
        const seconds = Math.floor(elapsed / 1000);
        const minutes = Math.floor(seconds / 60);
        const remainingSeconds = seconds % 60;
        
        document.getElementById('timer').textContent = 
            `${minutes.toString().padStart(2, '0')}:${remainingSeconds.toString().padStart(2, '0')}`;
    }
    
    function uploadVideo(videoBlob) {
        const formData = new FormData();
        formData.append('video', videoBlob, 'captured-video.webm');
        formData.append('contentType', 'video');
        formData.append('title', 'Captured Video');
        formData.append('published', 'off');
        
        fetch('/add-content', {
            method: 'POST',
            body: formData
        })
        .then(response => {
            if (response.ok) {
                document.getElementById('recordingStatus').textContent = 'Video saved as draft!';
                setTimeout(() => {
                    closeVideoModal();
                    location.reload();
                }, 2000);
            } else {
                throw new Error('Upload failed');
            }
        })
        .catch(error => {
            console.error('Upload error:', error);
            document.getElementById('recordingStatus').textContent = 'Upload failed. Please try again.';
            document.getElementById('recordingStatus').style.color = '#dc3545';
        });
    }
    
    // Photo Capture Functions
    function openPhotoCapture() {
        document.getElementById('photoModal').style.display = 'block';
        startPhotoStream();
    }
    
    function closePhotoModal() {
        document.getElementById('photoModal').style.display = 'none';
        stopPhotoStream();
    }
    
    function startPhotoStream() {
        navigator.mediaDevices.getUserMedia({ video: true })
            .then(stream => {
                const photoPreview = document.getElementById('photoPreview');
                photoPreview.srcObject = stream;
                window.photoStream = stream;
            })
            .catch(err => {
                console.error('Error accessing camera:', err);
                alert('Unable to access camera. Please check permissions.');
            });
    }
    
    function stopPhotoStream() {
        if (window.photoStream) {
            window.photoStream.getTracks().forEach(track => track.stop());
            window.photoStream = null;
        }
    }
    
    function capturePhoto() {
        const canvas = document.createElement('canvas');
        const video = document.getElementById('photoPreview');
        const context = canvas.getContext('2d');
        
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        context.drawImage(video, 0, 0);
        
        canvas.toBlob(blob => {
            uploadPhoto(blob);
        }, 'image/jpeg', 0.8);
    }
    
    function uploadPhoto(photoBlob) {
        const formData = new FormData();
        formData.append('image', photoBlob, 'captured-photo.jpg');
        formData.append('contentType', 'image');
        formData.append('title', 'Captured Photo');
        formData.append('published', 'off');
        
        fetch('/add-content', {
            method: 'POST',
            body: formData
        })
        .then(response => {
            if (response.ok) {
                alert('Photo saved as draft!');
                closePhotoModal();
                location.reload();
            } else {
                throw new Error('Upload failed');
            }
        })
        .catch(error => {
            console.error('Upload error:', error);
            alert('Upload failed. Please try again.');
        });
    }
</script>

<style>
    /* Bottom Navigation */
    .bottom-nav {
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        background: white;
        border-top: 1px solid #eee;
        padding: 1rem;
        display: flex;
        justify-content: center;
        gap: 1rem;
        z-index: 1000;
        box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.1);
    }
    
    .camera-btn {
        display: flex;
        flex-direction: column;
        align-items: center;
        padding: 0.75rem 1.5rem;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        text-decoration: none;
        border-radius: 25px;
        font-weight: 600;
        transition: transform 0.2s ease;
        border: none;
        cursor: pointer;
        min-width: 120px;
    }
    
    .camera-btn:hover {
        transform: translateY(-2px);
    }
    
    .camera-btn i {
        font-size: 1.5rem;
        margin-bottom: 0.25rem;
    }
    
    .camera-btn span {
        font-size: 0.9rem;
    }
    
    .video-btn {
        background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
    }
    
    .photo-btn {
        background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%);
    }
    
    /* Add padding to body to account for fixed bottom nav */
    body {
        padding-bottom: 100px;
    }
    
    /* Modal Styles */
    .modal {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.8);
        z-index: 2000;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    
    .modal-content {
        background: white;
        border-radius: 10px;
        max-width: 500px;
        width: 90%;
        max-height: 80vh;
        overflow-y: auto;
    }
    
    .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 1rem;
        border-bottom: 1px solid #eee;
    }
    
    .modal-header h3 {
        margin: 0;
        color: #333;
    }
    
    .close-btn {
        background: none;
        border: none;
        font-size: 1.5rem;
        cursor: pointer;
        color: #666;
    }
    
    .modal-body {
        padding: 1rem;
    }
    
    .video-controls, .photo-controls {
        text-align: center;
        margin-top: 1rem;
    }
    
    .record-btn, .capture-btn {
        background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
        color: white;
        border: none;
        padding: 0.75rem 1.5rem;
        border-radius: 25px;
        font-weight: 600;
        cursor: pointer;
        margin: 0.5rem;
    }
    
    .record-btn.stop-btn {
        background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
    }
    
    .timer {
        font-size: 1.5rem;
        font-weight: bold;
        color: #dc3545;
        margin: 1rem 0;
    }
    
    .recording-status {
        text-align: center;
        font-weight: 600;
        margin-top: 1rem;
    }
</style>

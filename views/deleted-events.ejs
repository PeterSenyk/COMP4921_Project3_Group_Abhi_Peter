<%- include('templates/header') %>

<style>
  .deleted-events-container {
    max-width: 1000px;
    margin: 2rem auto;
    padding: 0 1rem;
  }

  .deleted-events-container h1 {
    color: #333;
    margin-bottom: 1.5rem;
    font-size: 2rem;
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }

  .empty-state {
    background: white;
    border-radius: 10px;
    box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
    padding: 3rem;
    text-align: center;
    color: #666;
  }

  .empty-state-icon {
    font-size: 4rem;
    margin-bottom: 1rem;
  }

  .events-table-container {
    background: white;
    border-radius: 8px;
    box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
    overflow: hidden;
  }

  table {
    width: 100%;
    border-collapse: collapse;
  }

  thead {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
  }

  thead th {
    padding: 1rem;
    text-align: left;
    font-weight: 600;
    font-size: 0.95rem;
  }

  tbody tr {
    border-bottom: 1px solid #e0e0e0;
    transition: background-color 0.2s;
  }

  tbody tr:hover {
    background-color: #f5f5f5;
  }

  tbody tr:last-child {
    border-bottom: none;
  }

  tbody td {
    padding: 1rem;
    color: #333;
  }

  .event-title {
    font-weight: 600;
    color: #333;
  }

  .event-description {
    color: #666;
    font-size: 0.9rem;
    margin-top: 0.25rem;
  }

  .event-dates {
    color: #666;
    font-size: 0.9rem;
  }

  .days-badge {
    display: inline-block;
    padding: 0.25rem 0.75rem;
    border-radius: 12px;
    font-size: 0.85rem;
    font-weight: 500;
  }

  .days-badge.restorable {
    background-color: #d4edda;
    color: #155724;
  }

  .days-badge.expired {
    background-color: #f8d7da;
    color: #721c24;
  }

  .action-buttons {
    display: flex;
    gap: 0.5rem;
  }

  .btn {
    padding: 0.5rem 1rem;
    border: none;
    border-radius: 5px;
    cursor: pointer;
    font-weight: 500;
    transition: all 0.2s;
    text-decoration: none;
    display: inline-block;
    font-size: 0.9rem;
  }

  .btn-restore {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
  }

  .btn-restore:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(102, 126, 234, 0.3);
  }

  .btn-restore:disabled {
    background: #ccc;
    cursor: not-allowed;
    transform: none;
    box-shadow: none;
  }

  .btn-delete {
    background: #dc3545;
    color: white;
    display: flex;
    align-items: center;
    gap: 0.5rem;
    justify-content: center;
    white-space: nowrap;
  }

  .btn-delete:hover {
    background: #c82333;
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(220, 53, 69, 0.3);
  }

  .btn-delete:disabled {
    background: #ccc;
    cursor: not-allowed;
    transform: none;
    box-shadow: none;
  }

  .error-message {
    background: #f8d7da;
    color: #721c24;
    padding: 1rem;
    border-radius: 5px;
    margin-bottom: 1rem;
  }

  .success-message {
    background: #d4edda;
    color: #155724;
    padding: 1rem;
    border-radius: 5px;
    margin-bottom: 1rem;
  }

  .loading {
    opacity: 0.6;
    pointer-events: none;
  }
</style>

<div class="deleted-events-container">
  <h1>
    <span>üóëÔ∏è</span>
    Deleted Events
  </h1>

  <% if (typeof error !== 'undefined' && error) { %>
  <div class="error-message"><%= error %></div>
  <% } %>

  <div id="message-container"></div>

  <% if (typeof deletedEvents !== 'undefined' && deletedEvents.length > 0) { %>
  <div class="events-table-container">
    <table>
      <thead>
        <tr>
          <th>Title</th>
          <th>Date & Time</th>
          <th>Deleted</th>
          <th>Status</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        <% deletedEvents.forEach(function(event) { %>
        <tr id="event-row-<%= event.event_id %>">
          <td>
            <div class="event-title"><%= event.title %></div>
            <% if (event.description) { %>
            <div class="event-description"><%= event.description %></div>
            <% } %>
          </td>
          <td>
            <div class="event-dates">
              <div>
                <strong>Start:</strong>
                <%= new Date(event.start_at).toLocaleString() %>
              </div>
              <div>
                <strong>End:</strong>
                <%= new Date(event.end_at).toLocaleString() %>
              </div>
            </div>
          </td>
          <td>
            <div class="event-dates">
              <%= new Date(event.deleted_at).toLocaleString() %>
            </div>
          </td>
          <td>
            <% if (event.isRestorable) { %>
            <span class="days-badge restorable">
              Can restore (<%= event.daysSinceDeletion %> days ago)
            </span>
            <% } else { %>
            <span class="days-badge expired">
              Expired (<%= event.daysSinceDeletion %> days ago)
            </span>
            <% } %>
          </td>
          <td>
            <div class="action-buttons">
              <% if (event.isRestorable) { %>
              <button
                class="btn btn-restore"
                onclick="restoreEvent(<%= event.event_id %>)"
                id="restore-btn-<%= event.event_id %>"
              >
                Restore
              </button>
              <% } %>
              <button
                class="btn btn-delete"
                onclick="permanentlyDeleteEvent(<%= event.event_id %>)"
                id="delete-btn-<%= event.event_id %>"
                <% if (!event.isRestorable) { %>
                title="Permanently delete this event"
                <% } %>
               > 
                Delete üóëÔ∏è 
              </button>
            </div>
          </td>
        </tr>
        <% }); %>
      </tbody>
    </table>
  </div>
  <% } else { %>
  <div class="empty-state">
    <div class="empty-state-icon">üóëÔ∏è</div>
    <h2>No Deleted Events</h2>
    <p>Your trash bin is empty. Deleted events will appear here.</p>
    <a href="/calendar" class="btn btn-restore" style="margin-top: 1rem"
      >Back to Calendar</a
    >
  </div>
  <% } %>
</div>

<script>
  function showMessage(message, type = "success") {
    const container = document.getElementById("message-container");
    const messageDiv = document.createElement("div");
    messageDiv.className =
      type === "success" ? "success-message" : "error-message";
    messageDiv.textContent = message;
    container.appendChild(messageDiv);

    setTimeout(() => {
      messageDiv.remove();
    }, 5000);
  }

  async function restoreEvent(eventId) {
    const btn = document.getElementById(`restore-btn-${eventId}`);
    const row = document.getElementById(`event-row-${eventId}`);

    if (btn.disabled) return;

    btn.disabled = true;
    row.classList.add("loading");

    try {
      const response = await fetch(`/api/events/${eventId}/restore`, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
        },
      });

      const data = await response.json();

      if (response.ok) {
        showMessage("Event restored successfully!", "success");
        setTimeout(() => {
          window.location.reload();
        }, 1000);
      } else {
        showMessage(data.error || "Failed to restore event", "error");
        btn.disabled = false;
        row.classList.remove("loading");
      }
    } catch (error) {
      console.error("Error restoring event:", error);
      showMessage("An error occurred while restoring the event", "error");
      btn.disabled = false;
      row.classList.remove("loading");
    }
  }

  async function permanentlyDeleteEvent(eventId) {
    if (
      !confirm(
        "Are you sure you want to permanently delete this event? This action cannot be undone."
      )
    ) {
      return;
    }

    const btn = document.getElementById(`delete-btn-${eventId}`);
    const row = document.getElementById(`event-row-${eventId}`);

    if (btn.disabled) return;

    btn.disabled = true;
    row.classList.add("loading");

    try {
      const response = await fetch(`/api/events/${eventId}/permanent`, {
        method: "DELETE",
        headers: {
          "Content-Type": "application/json",
        },
      });

      const data = await response.json();

      if (response.ok) {
        showMessage("Event permanently deleted", "success");
        setTimeout(() => {
          row.remove();
          // Check if table is now empty
          const tbody = document.querySelector("tbody");
          if (tbody && tbody.children.length === 0) {
            window.location.reload();
          }
        }, 1000);
      } else {
        showMessage(
          data.error || "Failed to permanently delete event",
          "error"
        );
        btn.disabled = false;
        row.classList.remove("loading");
      }
    } catch (error) {
      console.error("Error permanently deleting event:", error);
      showMessage("An error occurred while deleting the event", "error");
      btn.disabled = false;
      row.classList.remove("loading");
    }
  }
</script>

<%- include('templates/footer') %>

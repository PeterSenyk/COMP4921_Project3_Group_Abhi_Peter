<%- include('templates/header') %>

<style>
  .dashboard-container {
    max-width: 800px;
    margin: 2rem auto;
    padding: 0 1rem;
  }

  .card {
    background: white;
    border-radius: 10px;
    box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
    padding: 2rem;
    margin-bottom: 2rem;
  }

  .card h2 {
    margin-top: 0;
    color: #333;
    margin-bottom: 1.5rem;
  }

  .profile-section {
    display: flex;
    align-items: center;
    gap: 2rem;
    margin-bottom: 1.5rem;
  }

  .profile-image-large {
    width: 100px;
    height: 100px;
    border-radius: 50%;
    object-fit: cover;
    border: 3px solid #667eea;
  }

  .profile-placeholder-large {
    width: 100px;
    height: 100px;
    border-radius: 50%;
    background: #667eea;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-weight: bold;
    font-size: 2.5rem;
    border: 3px solid #667eea;
  }

  .profile-info {
    flex: 1;
  }

  .profile-info h3 {
    margin: 0 0 0.5rem 0;
    color: #333;
  }

  .profile-info p {
    color: #666;
    margin: 0.25rem 0;
  }

  .file-input-wrapper {
    position: relative;
    display: inline-block;
  }

  .file-input-wrapper input[type="file"] {
    position: absolute;
    opacity: 0;
    width: 0;
    height: 0;
  }

  .file-input-label {
    display: inline-block;
    padding: 0.75rem 1.5rem;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border-radius: 5px;
    cursor: pointer;
    font-weight: 500;
    transition: transform 0.2s ease;
  }

  .file-input-label:hover {
    transform: translateY(-2px);
  }

  .upload-status {
    margin-top: 0.5rem;
    padding: 0.5rem;
    border-radius: 5px;
    display: none;
  }

  .upload-status.success {
    background: #d4edda;
    color: #155724;
    display: block;
  }

  .upload-status.error {
    background: #f8d7da;
    color: #721c24;
    display: block;
  }
</style>

<div class="dashboard-container">
  <div class="card">
    <h2>Dashboard</h2>
    <p>
      Welcome, <%= typeof currentUser !== 'undefined' && currentUser ?
      currentUser.username : 'User' %>!
    </p>
  </div>

  <div class="card">
    <h2>Profile Picture</h2>
    <div class="profile-section">
      <% if (typeof currentUser !== 'undefined' && currentUser &&
      currentUser.profile_image_url) { %>
      <img
        src="<%= currentUser.profile_image_url %>"
        alt="Profile"
        class="profile-image-large"
        id="profile-image-display"
      />
      <% } else { %>
      <div class="profile-placeholder-large" id="profile-image-display">
        <%= typeof currentUser !== 'undefined' && currentUser ?
        currentUser.username.charAt(0).toUpperCase() : '?' %>
      </div>
      <% } %>
      <div class="profile-info">
        <h3>Your Profile Picture</h3>
        <p>
          Upload a new profile picture to display with your posts and comments.
        </p>
        <div class="file-input-wrapper">
          <input type="file" id="profile-image-input" accept="image/*" />
          <label for="profile-image-input" class="file-input-label">
            Choose Image
          </label>
        </div>
        <div class="upload-status" id="upload-status"></div>
      </div>
    </div>
  </div>
</div>

<script>
  const fileInput = document.getElementById("profile-image-input");
  const uploadStatus = document.getElementById("upload-status");
  const profileDisplay = document.getElementById("profile-image-display");

  fileInput.addEventListener("change", async (e) => {
    const file = e.target.files[0];
    if (!file) return;

    // Validate file type
    if (!file.type.startsWith("image/")) {
      showStatus("Please select an image file", "error");
      return;
    }

    // Validate file size (max 5MB)
    if (file.size > 5 * 1024 * 1024) {
      showStatus("File size must be less than 5MB", "error");
      return;
    }

    const formData = new FormData();
    formData.append("profileImage", file);

    try {
      uploadStatus.textContent = "Uploading...";
      uploadStatus.className = "upload-status";
      uploadStatus.style.display = "block";

      const response = await fetch("/profile/upload-image", {
        method: "POST",
        body: formData,
      });

      if (response.ok) {
        const data = await response.json();
        showStatus("Profile picture uploaded successfully!", "success");

        // Update display
        if (profileDisplay.tagName === "IMG") {
          profileDisplay.src = data.imageUrl;
        } else {
          // Replace placeholder with image
          const img = document.createElement("img");
          img.src = data.imageUrl;
          img.alt = "Profile";
          img.className = "profile-image-large";
          img.id = "profile-image-display";
          profileDisplay.parentNode.replaceChild(img, profileDisplay);
        }

        // Clear file input
        fileInput.value = "";
      } else {
        const error = await response.json();
        showStatus("Error: " + (error.error || "Upload failed"), "error");
      }
    } catch (error) {
      console.error("Upload error:", error);
      showStatus("An error occurred during upload", "error");
    }
  });

  function showStatus(message, type) {
    uploadStatus.textContent = message;
    uploadStatus.className = `upload-status ${type}`;
    setTimeout(() => {
      uploadStatus.style.display = "none";
    }, 5000);
  }
</script>

<%- include('templates/footer') %>
